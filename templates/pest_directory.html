{% extends "base.html" %}

{% block title %}Pest Directory - PEST-Hub{% endblock %}

{% block additional_styles %}
<link rel="stylesheet" href="{{ url_for('css_assets', filename='directory.css') }}">
{% endblock %}

{% block content %}
<div class="directory-container">
    <!-- Header Section -->
    <div class="directory-header">
        <div class="header-content">
            <h1>Comprehensive Pest Directory</h1>
            <div class="hero-description">
                <p>Explore detailed information about pests with AI-powered custom search. Browse our curated database or search for any pest by name.</p>
            </div>
            
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="stat-card">
                    <div class="stat-number">{{ pests|length }}</div>
                    <div class="stat-label">Curated Pests</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">100%</div>
                    <div class="stat-label">AI Powered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">âˆž</div>
                    <div class="stat-label">Custom Search</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Section -->
    <div class="search-filter-section">
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Search pests by name, type, or symptoms...">
                <button class="clear-btn" id="clear-search" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <div class="filter-controls">
            <div class="filter-group">
                <label for="category-filter">Category:</label>
                <select id="category-filter">
                    <option value="">All Categories</option>
                    <option value="flying">Flying Pests</option>
                    <option value="crawling">Crawling Pests</option>
                    <option value="soft-bodied">Soft-bodied Pests</option>
                    <option value="hard-bodied">Hard-bodied Pests</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label for="threat-filter">Threat Level:</label>
                <select id="threat-filter">
                    <option value="">All Threats</option>
                    <option value="high">High Risk</option>
                    <option value="medium">Medium Risk</option>
                    <option value="low">Low Risk</option>
                </select>
            </div>
            
            <div class="view-toggle">
                <button class="view-btn active" data-view="grid" title="Grid View">
                    <i class="fas fa-th"></i>
                </button>
                <button class="view-btn" data-view="list" title="List View">
                    <i class="fas fa-list"></i>
                </button>
            </div>
            
            <button class="reset-btn" id="reset-filters">
                <i class="fas fa-undo"></i> Reset
            </button>
            
            <button class="custom-search-btn" id="custom-search-btn" onclick="openCustomSearchModal()">
                <i class="fas fa-sparkles"></i> Custom Search
            </button>
        </div>
    </div>

    <!-- Custom Search Results Section -->
    <div id="custom-search-results" class="custom-search-results" style="display: none;">
        <h3><i class="fas fa-robot"></i> AI-Generated Search Results</h3>
        <div id="custom-pest-container" class="pest-container"></div>
    </div>

    <!-- Results Section -->
    <div class="results-section">
        <div class="results-header">
            <div class="results-count" id="results-count">
                Showing {{ pests|length }} pests
            </div>
            <div class="sort-controls">
                <label for="sort-by">Sort by:</label>
                <select id="sort-by">
                    <option value="name">Name</option>
                    <option value="threat">Threat Level</option>
                    <option value="category">Category</option>
                </select>
            </div>
        </div>

        <div class="pest-container grid-view" id="pest-container">
            {% for pest in pests %}
            <div class="pest-card" 
                 data-name="{{ pest.name|lower }}" 
                 data-category="{{ pest.name|get_category|lower }}" 
                 data-threat="{{ pest.name|get_threat_level|lower }}"
                 data-scientific="{{ pest.scientific_name|lower }}"
                 data-pest-name="{{ pest.name }}"
                 data-pest-scientific="{{ pest.scientific_name }}"
                 data-pest-description="{{ pest.description }}"
                 data-pest-image="{{ pest.image }}"
                 data-pest-symptoms='{{ pest.symptoms|tojson }}'
                 data-pest-url="{{ url_for('pest_details', pest_name=pest.name.lower().replace(' ', '_')) }}"
                 onclick="openPreviewModalFromData(this)">
                
                <div class="pest-image-section">
                    <img src="{{ url_for('public_assets', filename='images/pests/' + pest.image) }}" 
                         alt="{{ pest.name }}" class="pest-image">
                    <div class="pest-badge">{{ pest.name|get_threat_level|title }} Risk</div>
                </div>
                
                <div class="pest-content">
                    <div class="pest-header">
                        <div class="pest-title">
                            <h3>{{ pest.name }}</h3>
                            <p class="pest-scientific">{{ pest.scientific_name }}</p>
                        </div>
                        <div class="pest-type-badge">{{ pest.name|get_category_display }}</div>
                    </div>
                    
                    <p class="pest-description">{{ pest.description[:120] }}...</p>
                    
                    <div class="quick-info">
                        <h4>Quick Info</h4>
                        <div class="info-list">
                            <div class="info-item">
                                <i class="fas fa-eye"></i>
                                <span>Variable sizes</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-leaf"></i>
                                <span>Multiple crops</span>
                            </div>
                            <div class="info-item">
                                <i class="fas fa-calendar"></i>
                                <span>Year-round</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="pest-actions">
                        <button class="btn btn-outline btn-sm quick-view-btn" onclick="event.stopPropagation();">
                            <i class="fas fa-eye"></i> Quick View
                        </button>
                        <a href="{{ url_for('pest_details', pest_name=pest.name.lower().replace(' ', '_')) }}" 
                           class="btn btn-primary btn-sm" onclick="event.stopPropagation();">
                            <i class="fas fa-info-circle"></i> Learn More
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- No Results Message -->
        <div class="no-results" id="no-results" style="display: none;">
            <div class="no-results-icon">
                <i class="fas fa-search"></i>
            </div>
            <h3>No pests found</h3>
            <p>Try adjusting your search criteria or filters to find what you're looking for.</p>
            <button class="btn btn-primary" id="clear-all-filters">
                <i class="fas fa-undo"></i> Clear All Filters
            </button>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal" id="preview-modal">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="modal-title">Pest Preview</h3>
            <button class="modal-close" onclick="closePreviewModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="preview-content">
                <div class="preview-image-section">
                    <img id="modal-image" alt="Pest image" class="preview-main-image">
                    <div class="preview-image-details">
                        <div class="preview-detail-item">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span id="modal-threat-level">Threat Level</span>
                        </div>
                        <div class="preview-detail-item">
                            <i class="fas fa-tag"></i>
                            <span id="modal-category">Category</span>
                        </div>
                    </div>
                </div>
                <div class="preview-info">
                    <h4 id="modal-pest-name">Pest Name</h4>
                    <p id="modal-scientific-name">Scientific Name</p>
                    <p id="modal-description">Description</p>
                    
                    <div class="preview-symptoms">
                        <h5>Common Symptoms:</h5>
                        <ul id="modal-symptoms">
                            <!-- Symptoms will be populated by JavaScript -->
                        </ul>
                    </div>
                    
                    <div class="preview-actions">
                        <a href="#" id="modal-learn-more" class="btn btn-primary" target="_self">
                            <i class="fas fa-book"></i> Full Information
                        </a>
                        <button class="btn btn-outline" onclick="closePreviewModal()">
                            <i class="fas fa-times"></i> Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Custom Search Modal (outside directory-container) -->
<div id="custom-search-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-sparkles"></i> Custom Pest Search</h3>
            <button class="modal-close" onclick="closeCustomSearchModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p>Search for any pest by name - agricultural, household, or garden. Our AI will verify if it's a pest and provide detailed information.</p>
            <div class="custom-search-input-container">
                <input type="text" id="custom-search-input" placeholder="Enter pest name (e.g., 'Mosquitoes', 'Silverfish', 'Aphids')..." autofocus>
                <button class="btn btn-primary" id="custom-search-submit">
                    <i class="fas fa-search"></i> Search
                </button>
            </div>
            <div id="custom-search-status" class="custom-search-status"></div>
        </div>
    </div>
</div>

<script>
class PestDirectory {
    constructor() {
        this.allPests = Array.from(document.querySelectorAll('.pest-card'));
        this.searchInput = document.getElementById('search-input');
        this.clearSearchBtn = document.getElementById('clear-search');
        this.categoryFilter = document.getElementById('category-filter');
        this.threatFilter = document.getElementById('threat-filter');
        this.sortBy = document.getElementById('sort-by');
        this.viewToggle = document.querySelectorAll('.view-btn');
        this.resetBtn = document.getElementById('reset-filters');
        this.pestContainer = document.getElementById('pest-container');
        this.resultsCount = document.getElementById('results-count');
        this.noResults = document.getElementById('no-results');

        this.initEventListeners();
        this.updateResults();
    }

    initEventListeners() {
        this.searchInput.addEventListener('input', () => {
            this.toggleClearButton();
            this.filterPests();
        });

        this.clearSearchBtn.addEventListener('click', () => {
            this.searchInput.value = '';
            this.toggleClearButton();
            this.filterPests();
        });

        this.categoryFilter.addEventListener('change', () => this.filterPests());
        this.threatFilter.addEventListener('change', () => this.filterPests());
        this.sortBy.addEventListener('change', () => this.sortPests());

        this.viewToggle.forEach(btn => {
            btn.addEventListener('click', () => this.toggleView(btn));
        });

        this.resetBtn.addEventListener('click', () => this.resetAllFilters());
        document.getElementById('clear-all-filters').addEventListener('click', () => this.resetAllFilters());
    }

    toggleClearButton() {
        this.clearSearchBtn.style.display = this.searchInput.value ? 'block' : 'none';
    }

    filterPests() {
        const searchTerm = this.searchInput.value.toLowerCase();
        const categoryFilter = this.categoryFilter.value;
        const threatFilter = this.threatFilter.value;

        let visibleCount = 0;

        this.allPests.forEach(pest => {
            const name = pest.dataset.name;
            const scientific = pest.dataset.scientific;
            const category = pest.dataset.category;
            const threat = pest.dataset.threat;

            const matchesSearch = !searchTerm || 
                name.includes(searchTerm) || 
                scientific.includes(searchTerm);
            
            const matchesCategory = !categoryFilter || category === categoryFilter;
            const matchesThreat = !threatFilter || threat === threatFilter;

            const isVisible = matchesSearch && matchesCategory && matchesThreat;
            
            pest.style.display = isVisible ? 'block' : 'none';
            if (isVisible) visibleCount++;
        });

        this.updateResults(visibleCount);
        this.sortPests();
    }

    sortPests() {
        const sortBy = this.sortBy.value;
        const visiblePests = this.allPests.filter(pest => pest.style.display !== 'none');
        
        visiblePests.sort((a, b) => {
            let aVal, bVal;
            
            switch(sortBy) {
                case 'name':
                    aVal = a.dataset.name;
                    bVal = b.dataset.name;
                    break;
                case 'threat':
                    const threatOrder = { 'high': 3, 'medium': 2, 'low': 1 };
                    aVal = threatOrder[a.dataset.threat];
                    bVal = threatOrder[b.dataset.threat];
                    return bVal - aVal; // Descending for threat
                case 'category':
                    aVal = a.dataset.category;
                    bVal = b.dataset.category;
                    break;
                default:
                    aVal = a.dataset.name;
                    bVal = b.dataset.name;
            }
            
            return aVal.localeCompare(bVal);
        });

        // Reorder elements in DOM
        visiblePests.forEach(pest => {
            this.pestContainer.appendChild(pest);
        });
    }

    toggleView(activeBtn) {
        this.viewToggle.forEach(btn => btn.classList.remove('active'));
        activeBtn.classList.add('active');
        
        const view = activeBtn.dataset.view;
        this.pestContainer.className = `pest-container ${view}-view`;
    }

    updateResults(count = null) {
        const displayCount = count !== null ? count : this.allPests.length;
        this.resultsCount.textContent = `Showing ${displayCount} pest${displayCount !== 1 ? 's' : ''}`;
        
        this.noResults.style.display = displayCount === 0 ? 'block' : 'none';
        this.pestContainer.style.display = displayCount === 0 ? 'none' : 'grid';
    }

    resetAllFilters() {
        this.searchInput.value = '';
        this.categoryFilter.value = '';
        this.threatFilter.value = '';
        this.sortBy.value = 'name';
        this.toggleClearButton();
        
        this.allPests.forEach(pest => {
            pest.style.display = 'block';
        });
        
        this.updateResults();
        this.sortPests();
    }

    closePreviewModal() {
        const modal = document.getElementById('preview-modal');
        modal.classList.remove('active');
        modal.style.display = 'none';
        document.body.style.overflow = ''; // Re-enable background scrolling
    }
}

function openPreviewModalFromData(card) {
    const name = card.dataset.pestName;
    const scientificName = card.dataset.pestScientific;
    const description = card.dataset.pestDescription;
    const image = card.dataset.pestImage;
    const symptomsJson = card.dataset.pestSymptoms;
    const learnMoreUrl = card.dataset.pestUrl;
    const category = card.dataset.category;
    const threat = card.dataset.threat;
    
    let symptoms = [];
    try {
        symptoms = JSON.parse(symptomsJson);
        console.log('Parsed symptoms for', name, ':', symptoms);
    } catch (e) {
        console.error('Error parsing symptoms for', name, ':', e);
        console.error('Symptoms JSON:', symptomsJson);
        symptoms = [];
    }
    
    openPreviewModal(name, scientificName, description, image, symptoms, learnMoreUrl, category, threat);
}

function openPreviewModal(name, scientificName, description, image, symptoms, learnMoreUrl, category, threat) {
    const modal = document.getElementById('preview-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalImage = document.getElementById('modal-image');
    const modalPestName = document.getElementById('modal-pest-name');
    const modalScientificName = document.getElementById('modal-scientific-name');
    const modalDescription = document.getElementById('modal-description');
    const modalSymptoms = document.getElementById('modal-symptoms');
    const modalLearnMore = document.getElementById('modal-learn-more');
    const modalThreatLevel = document.getElementById('modal-threat-level');
    const modalCategory = document.getElementById('modal-category');

    modalTitle.textContent = name;
    modalImage.src = `/assets/images/pests/${image}`;
    modalImage.alt = name;
    modalPestName.textContent = name;
    modalScientificName.textContent = scientificName;
    modalDescription.textContent = description;
    
    // Set the learn more link properly
    modalLearnMore.href = learnMoreUrl;
    modalLearnMore.onclick = function(e) {
        e.stopPropagation();
        window.location.href = learnMoreUrl;
        return false;
    };
    
    // Set threat level with proper styling
    const threatText = threat ? threat.charAt(0).toUpperCase() + threat.slice(1) + ' Risk' : 'Medium Risk';
    modalThreatLevel.textContent = threatText;
    modalThreatLevel.className = `threat-badge ${threat || 'medium'}`;
    
    // Set category
    const categoryMap = {
        'flying': 'Flying Pest',
        'crawling': 'Crawling Pest',
        'soft-bodied': 'Soft-bodied Pest',
        'larval': 'Larval Pest'
    };
    modalCategory.textContent = categoryMap[category] || 'Agricultural Pest';

    // Clear existing symptoms
    modalSymptoms.innerHTML = '';
    
    // Add symptoms (intelligently choose 2 or 3 based on length)
    if (Array.isArray(symptoms) && symptoms.length > 0) {
        // Check the length of the first 3 symptoms
        const first3Symptoms = symptoms.slice(0, 3);
        const avgLength = first3Symptoms.reduce((sum, symptom) => sum + symptom.length, 0) / first3Symptoms.length;
        
        console.log(name, 'avg symptom length:', avgLength);
        
        // If symptoms are long (avg > 70 chars), show 2; otherwise show 3
        const numberOfSymptoms = avgLength > 70 ? 2 : 3;
        
        const symptomsToShow = symptoms.slice(0, numberOfSymptoms);
        symptomsToShow.forEach(symptom => {
            const li = document.createElement('li');
            li.textContent = symptom;
            modalSymptoms.appendChild(li);
        });
    } else {
        // Fallback if no symptoms available
        const li = document.createElement('li');
        li.textContent = 'Visible pest presence and crop damage';
        modalSymptoms.appendChild(li);
    }

    modal.classList.add('active');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
}

function resetAllFilters() {
    if (window.pestDirectory) {
        window.pestDirectory.resetAllFilters();
    }
}

function closePreviewModal() {
    if (window.pestDirectory) {
        window.pestDirectory.closePreviewModal();
    } else {
        const modal = document.getElementById('preview-modal');
        modal.classList.remove('active');
        modal.style.display = 'none';
        document.body.style.overflow = '';
    }
}

// Store instance globally
document.addEventListener('DOMContentLoaded', () => {
    window.pestDirectory = new PestDirectory();
    
    // Close modal when clicking outside of it
    const modal = document.getElementById('preview-modal');
    modal.addEventListener('click', function(event) {
        if (event.target === modal) {
            closePreviewModal();
        }
    });
    
    // Close modal with Escape key
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            closePreviewModal();
        }
    });
    
    // Add click handlers to Quick View buttons
    document.querySelectorAll('.quick-view-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation();
            const card = this.closest('.pest-card');
            if (card) {
                openPreviewModalFromData(card);
            }
        });
    });
    
    // Custom Search Modal Functions
    const customSearchBtn = document.getElementById('custom-search-btn');
    const customSearchModal = document.getElementById('custom-search-modal');
    const customSearchInput = document.getElementById('custom-search-input');
    const customSearchSubmit = document.getElementById('custom-search-submit');
    const customSearchStatus = document.getElementById('custom-search-status');
    const customSearchResults = document.getElementById('custom-search-results');
    const customPestContainer = document.getElementById('custom-pest-container');
    
    if (customSearchBtn && customSearchModal) {
        customSearchBtn.addEventListener('click', () => {
            console.log('Custom search button clicked');
            customSearchModal.classList.add('active');
            customSearchModal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            if (customSearchInput) customSearchInput.focus();
            if (customSearchStatus) customSearchStatus.innerHTML = '';
        });
    } else {
        console.error('Custom search elements not found:', {
            btn: !!customSearchBtn,
            modal: !!customSearchModal
        });
    }
    
    if (customSearchSubmit) {
        customSearchSubmit.addEventListener('click', performCustomSearch);
    }
    
    if (customSearchInput) {
        customSearchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                performCustomSearch();
            }
        });
    }
    
    // Click outside to close
    if (customSearchModal) {
        customSearchModal.addEventListener('click', (e) => {
            if (e.target === customSearchModal) {
                closeCustomSearchModal();
            }
        });
    }
});

function openCustomSearchModal() {
    const modal = document.getElementById('custom-search-modal');
    const input = document.getElementById('custom-search-input');
    const status = document.getElementById('custom-search-status');
    
    if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        if (input) {
            setTimeout(() => input.focus(), 100);
        }
        if (status) {
            status.innerHTML = '';
        }
    }
}

function closeCustomSearchModal() {
    const modal = document.getElementById('custom-search-modal');
    const input = document.getElementById('custom-search-input');
    const status = document.getElementById('custom-search-status');
    
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    if (input) {
        input.value = '';
    }
    if (status) {
        status.innerHTML = '';
    }
}

async function performCustomSearch() {
    const input = document.getElementById('custom-search-input');
    const status = document.getElementById('custom-search-status');
    const query = input.value.trim();
    
    if (!query) {
        status.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-circle"></i> Please enter a pest name.</p>';
        return;
    }
    
    // Show loading state
    status.innerHTML = '<p class="loading-message"><i class="fas fa-spinner fa-spin"></i> Searching with AI...</p>';
    
    try {
        const response = await fetch('/search_pest', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ query: query })
        });
        
        const data = await response.json();
        
        if (data.error) {
            status.innerHTML = `<p class="error-message"><i class="fas fa-exclamation-circle"></i> Error: ${data.error}</p>`;
            return;
        }
        
        if (!data.is_pest) {
            status.innerHTML = '<p class="error-message"><i class="fas fa-times-circle"></i> No results found. This doesn\'t appear to be a pest or insect.</p>';
            return;
        }
        
        // Success! Close modal and display result
        status.innerHTML = '<p class="success-message"><i class="fas fa-check-circle"></i> Pest found! Generating card...</p>';
        
        setTimeout(() => {
            closeCustomSearchModal();
            displayCustomPestCard(data.pest_data);
        }, 800);
        
    } catch (error) {
        console.error('Error:', error);
        status.innerHTML = '<p class="error-message"><i class="fas fa-exclamation-circle"></i> An error occurred. Please try again.</p>';
    }
}

function displayCustomPestCard(pestData) {
    const customSearchResults = document.getElementById('custom-search-results');
    const customPestContainer = document.getElementById('custom-pest-container');
    
    // Show the custom search results section
    customSearchResults.style.display = 'block';
    
    // Scroll to the results
    customSearchResults.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    // Create the pest card
    const threatClass = pestData.threat_level || 'medium';
    const threatText = threatClass.charAt(0).toUpperCase() + threatClass.slice(1) + ' Threat';
    
    // For custom searches, use placeholder image
    const imageUrl = pestData.image === 'placeholder' 
        ? '/assets/images/ui/hero-pest-detection.png' 
        : `/assets/images/pests/${pestData.image}`;
    
    const symptomsJson = JSON.stringify(pestData.symptoms || []);
    
    const cardHTML = `
        <div class="pest-card custom-pest-card"
             data-pest-name="${pestData.name}"
             data-pest-scientific="${pestData.scientific_name}"
             data-pest-description="${pestData.description}"
             data-pest-image="${imageUrl}"
             data-pest-symptoms='${symptomsJson}'
             data-pest-url="${pestData.info_url}"
             data-threat="${threatClass}"
             data-category="${pestData.category.toLowerCase().replace(' pest', '')}"
             onclick="window.location.href='${pestData.info_url}'">
            
            <div class="pest-image-section">
                <img src="${imageUrl}" alt="${pestData.name}" class="pest-image">
                <div class="pest-overlay">
                    <span class="threat-level ${threatClass}">
                        <i class="fas fa-exclamation-triangle"></i>
                        ${threatText}
                    </span>
                </div>
                <div class="ai-badge">
                    <i class="fas fa-robot"></i> AI Generated
                </div>
            </div>
            
            <div class="pest-content">
                <div class="pest-header">
                    <h3 class="pest-name">${pestData.name}</h3>
                    <span class="pest-category">${pestData.category}</span>
                </div>
                <p class="pest-scientific">${pestData.scientific_name}</p>
                <p class="pest-summary">${pestData.description}</p>
                
                <div class="pest-actions">
                    <button class="btn btn-outline btn-sm quick-view-btn" onclick="event.stopPropagation();">
                        <i class="fas fa-eye"></i> Quick View
                    </button>
                    <a href="${pestData.info_url}" class="btn btn-primary btn-sm">
                        <i class="fas fa-arrow-right"></i> Learn More
                    </a>
                </div>
            </div>
        </div>
    `;
    
    customPestContainer.innerHTML = cardHTML;
    
    // Add event listener to the new Quick View button
    const quickViewBtn = customPestContainer.querySelector('.quick-view-btn');
    if (quickViewBtn) {
        quickViewBtn.addEventListener('click', function(event) {
            event.stopPropagation();
            const card = this.closest('.pest-card');
            if (card) {
                openPreviewModalFromData(card);
            }
        });
    }
}
</script>
{% endblock %}
